/* eslint
no-alert: 0 */

ui.academy = {
    data: {
        interval: 7,
        init: {
            title: "ברוכה הבאה לקורס סטייל שבא מבפנים",
            shortTitle: "ברוכה הבאה",
            video: "yCsI9dSOvK0"
        },
        session: {
            colours: {
                title: "הצבע הזה הוא אני",
                video: "4kKzES9x35g",
                pages: {
                    "color-plates": {
                        type: "video",
                        title: "סרטון: לוחות צבעים",
                        value: "_dohRGGGLmQ"
                    },
                    qa: {
                        type: "qa",
                        title: "שאלון:\nלאיזה קטגוריית צבעים את שייכת?",
                        value: "academy-colours.jpg",
                        option: [
                            {
                                title: "האם צבע השיער שלך שחור או חום כהה?",
                                option: [
                                    {
                                        title: "העיניים שלך מבריקות, בולטות, בצבע כחול כהה או ירוק כהה? האם יש קונטראסט בין הלבן בעיניים לבין האישון?",
                                        final: "clear"
                                    },
                                    {
                                        title: "העיניים שלך כהות?",
                                        final: "deep"
                                    },
                                    {
                                        title: "העיניים שלך בהירות, כחול בהיר או אפור בהיר?",
                                        final: "bright"
                                    }
                                ]
                            },
                            {
                                title: "האם צבע השיער שלך בלונד בהיר, אפור בהיר, חום בהיר?",
                                option: [
                                    {
                                        title: "העיניים שלך בהירות בצבעים כחול בהיר, אפור או ירוק בהיר?",
                                        final: "bright"
                                    },
                                    {
                                        title: "העיניים שלך חום בהיר, מתמזג עם צבע השיער?",
                                        final: "mixed"
                                    }
                                ]
                            },
                            {
                                title: "האם צבע השיער שלך חום בינוני או עכברי, אפור בינוני, בלונד אפורי, בלונד כהה?",
                                option: [
                                    {
                                        title: "העיניים שלך בהירות בצבעים כחול בהיר, אפור או ירוק בהיר?",
                                        final: "bright"
                                    },
                                    {
                                        title: "העיניים שלך חום בהיר, מתמזג עם צבע השיער?",
                                        final: "mixed"
                                    }
                                ]
                            },
                            {
                                title: "האם צבע השיער שלך ג'ינג'י, דבש, ערמוני, והעיניים שלך ירוק חם כהה, חום ירקרק, חום דבש, כחול ירוק?",
                                final: "warm"
                            },
                            {
                                title: "האם צבע השיער שלך חום אפרפר (עכברי), בלונדי-אפרורי, כסוף, שיבה אפור, והצבע העיניים שלך כחול או חום או ירקרק?",
                                final: "cold"
                            }
                        ],
                        final: {
                            clear: {
                                title: "את צלולה",
                                value: "1RBWFZEoSG2IBhZWX74-bFerykqF1sJns"
                            },
                            deep: {
                                title: "את עמוקה",
                                value: "1dB3YO4ph2X6G-5ljir0RLUUQn3l7tkTZ"
                            },
                            bright: {
                                title: "את בהירה",
                                value: "1F1juuLT-pHxU4FVlLEFXamQKesNd3AzO"
                            },
                            mixed: {
                                title: "את מעורבת",
                                value: "1bmSwDG6GGggZTUuNjDHxZNMSlwYa8SuW"
                            },
                            warm: {
                                title: "את חמה",
                                value: "1lml4F6bRh9yiz47x-t7Xs5sWjlo1mE9i"
                            },
                            cold: {
                                title: "את קרה",
                                value: "1OOitln7OtHB7qvUqvhvkHI7XnmLLwPUR"
                            }
                        }
                    }
                }
            },
            "body-shape": {
                title: "כמה טוב להיות את!",
                video: "xZMfS-HXqXM",
                pages: {
                    calculator: {
                        type: "calculator",
                        title: "מחשבון:\nתאבחני את מבנה הגוף שלך",
                        value: "1gKI_JUyD20fvq27_B3Kxq9vfJ6f99xLnnd1ht1vibhU",
                        button: "הצג תוצאה",
                        notice: "שימי לב, חישוב ניתן רק לפעם אחת",
                        result: "את בעלת מבנה גוף {0}",
                        download: "להורדת מדריך הגיזרות",
                        error: "שגיאה בחישוב, {0}נא לפנות ללאה{1}",
                        option: {
                            A: "היקף הכתפיים",
                            B: "היקף היריכיים",
                            C: "היקף המותן",
                            D: "היקף החזה"
                        },
                        final: {
                            hourglass: {
                                title: "שעון חול",
                                value: "1r5TBnSpeNRjTmwIaoKkiiqBBzNhESmdj"
                            },
                            invertedTriangle: {
                                title: "משולש הפוך",
                                value: "1_ekRaH2x8iP4jYovBSpVZuNUquO_WiJI"
                            },
                            triangle: {
                                title: "משולש",
                                value: "1ZFVcrckN8LhfZ8Gp9K7N1OUAn-BicVhD"
                            },
                            rounded: {
                                title: "מעוגל",
                                value: "1JWcPbgHI6uQRGVpr82zg5l79yDYYp39P"
                            },
                            square: {
                                title: "מרובע",
                                value: "1hRie1lANjULGnlUDrnUVPYjCxrD4n6Ws"
                            }
                        }
                    }
                }
            },
            style: {
                title: "על טעם, ריח, ואופי",
                video: "06Q_GGX5KLQ",
                pages: {
                    sat: {
                        type: "sat",
                        title: "שאלון:\nמצאי את סגנון הלבוש שלך",
                        next: "המשך",
                        back: "חזור",
                        button: "הצג תוצאה",
                        limit: "סמני מקסימום שתי תשובות",
                        value: "academy-style.jpg",
                        option: [
                            {
                                title: "כיצד את בוחרת את צבעי הבגדים שלך?",
                                option: {
                                    A: "בהתאם למצב רוח שלי באותו יום",
                                    B: "צבעים חזקים וקונטרסטים",
                                    C: "צבעי פסטל",
                                    D: "פריטי לבוש המתאימים מבחינת הצבעים, הבדים או הדוגמאות",
                                    E: "בשילובי צבעים ניטרליים ופשוטים או בצבעי אדמה"
                                }
                            }, {
                                title: "כיצד תגדירי את סגנון הקניות שלך?",
                                option: {
                                    A: "אוהבת לקנות בשווקים, יד שניה ובמבצעים",
                                    B: "קונה בלי לחשוב פעמיים כל דבר שמוצא חן בעיני",
                                    C: "הקניות עושות אותי שמחה ואני נהנת, אני יוצאת לקניות כשאני רוצה לשפר מצב רוח שלי",
                                    D: "הקניות שלי מתוכננות ונעשות על פי רשימה מוכנה מראש, משקיעה בפריטים איכותיים וקלאסיים שתמיד באופנה",
                                    E: "קונה בהתאם לצורך או לקראת אירועים מיוחדים. לא מוכנה לוותר על נוחות, במקרה הצורך אלך לתופרת"
                                }
                            }, {
                                title: "כיצד היית מגדירה את הופעתך באופן כללי?",
                                option: {
                                    A: "בעלת סגנון ייחודי המשלב פריטים שונים ויוצאי דופן",
                                    B: "בעלת אמירה אופנתית ופריטים המושכים תשומת לב",
                                    C: "אוהבת בגדים עם קישוטים עדינים הגורמים לי להרגיש נשית",
                                    D: "נקי ואלגנטי",
                                    E: "אוהבת בגדים נוחים"
                                }
                            }, {
                                title: "איזה מהפריטים בארון שלך משמשים אותך לעבודה?",
                                option: {
                                    A: "פריטי לבוש אקראיים שאני מערבבת ביניהם לפי טעמי האישי",
                                    B: "פריטים יוצאי דופן שתופסים את העין",
                                    C: "חולצות יפות ועליוניות שאני משלבת עם חצאיות",
                                    D: "פריטים בסיסיים הניתנים לשדרוג עם אביזרים, פריטים מחויטים",
                                    E: "פריטי לבוש יום יומיים, כמו מכנסי ג'ינס וחולצה פשוטים"
                                }
                            }, {
                                title: "איזה מהפריטים בארון שלך משמשים אותך לשעות הפנאי?",
                                option: {
                                    A: "אוסף פריטי לבוש בסגנון רטרו או וינטאג'",
                                    B: "הפריטים האופנתיים שנרכשו לאחרונה",
                                    C: "פריטים יפים ונשיים, עם תחרות",
                                    D: "פריטים בעלי סגנון פשוט שלהם אני מוספיה אביזרים",
                                    E: "בגדים נוחים ואיכותיים, מכותנה או פשתן, טוניקות"
                                }
                            }, {
                                title: "איזה מהפריטים בארון שלך שמורים לאירועים מיוחדים?",
                                option: {
                                    A: "שילבו בדים מיוחדים או גזרות מעניינות",
                                    B: "פריטים מיוחדים וגרנדיוזיים המושכים תשומת הלב",
                                    C: "שמלות נשיות וקלילות ומקושטות ועשויים מבדים קלילים",
                                    D: "חליפה אלגנטית ומחויטת או שמלה קלאסית וסולידית בשילוב תכשיטים אופנתיים",
                                    E: "חצאית אלגנטית ארוכה ונוחה או מכנסיים בשילוב עם חולצה נוחה וחגיגית או טוניקה"
                                }
                            }, {
                                title: "כיצד תתארי את הנעליים שלך?",
                                option: {
                                    A: "לאו דווקא מתאימות ללבוש שלי אבל מיוחדות",
                                    B: "לרוב בעלות עקבים",
                                    C: "יפות עם סרטים או קישוטים",
                                    D: "קלאסיות, מתאימות להרבה בגדים",
                                    E: "נוחות ושטוחות"
                                }
                            }, {
                                title: "איזה סוג תכשיטים את אוהבת?",
                                option: {
                                    A: "לא שגרתיים, ממש פריטי אספנות",
                                    B: "גדולים ובעלי אמירה אישית",
                                    C: "מורכבים ועשירים מאוד בפריטים, עם סלסולים ופרחים",
                                    D: "בעלי קו מעודן וקלאסי, עשויים מזהב או כסף",
                                    E: "עשויים בדרך כלל מחומרים טבעים"
                                }
                            }, {
                                title: "מהו יחסך לנושא האיפור?",
                                option: {
                                    A: "אוהבת להתנסות בדברים חדשים ומתחדשים כל הזמן",
                                    B: "אוהבת אותו מודגש וקצת מוגזם",
                                    C: "אוהבת ומשקיעה בו זמן רב",
                                    D: "לא מחדשת, דבקה בהרגלים שלי, אבל חשוב ומשלים את ההופעה שלי",
                                    E: "מינימליסטי, אם בכלל"
                                }
                            }, {
                                title: "מהו סגנון כיסוי ראש / שיער שלך?",
                                option: {
                                    A: "משתנה בהתאם למצב הרוח שלי",
                                    B: "משתנה בקביעות, משתנה בצבעוניות",
                                    C: "אוהבת להוציא שיער בצדדים. שיער ארוך",
                                    D: "מעודן ומשתלב עם הלבוש שלי",
                                    E: "דורש תחזוקה מינימלית"
                                }
                            }, {
                                title: "כשאת בוחרת חולצה מודפסת היא תהיה____?",
                                option: {
                                    A: "הדפס בסגנון חדש, שאין לי בארון",
                                    B: "הדפס דומיננטי",
                                    C: "עדין עם נקודות או פרחים קטנים",
                                    D: "בדרך כלל קונה פריטים ללא הדפס",
                                    E: "אוהבת חלק וגם אוהבת הדפס אתני"
                                }
                            }, {
                                title: "באיזה סגנון את רואה את עצמך מתלבשת?",
                                limit: "סמני תשובה אחת",
                                showImage: true,
                                condition: function (arr) {
                                    "use strict";

                                    var opt = {
                                            C: ["C", "F"],
                                            E: ["E", "G"],
                                            CD: ["C", "D"]
                                        },
                                        final = ui.academy.data.session.style.pages.sat.final,
                                        el = this.id && ui.d.getElementById(this.id),
                                        res,
                                        i;

                                    arr = opt[JSON.stringify(arr).replace(/[[,\]"]/g, "")];
                                    this.option = {};

                                    if (Array.isArray(arr)) {
                                        for (i = 0; i < arr.length; i += 1) {
                                            this.option[arr[i]] = final[arr[i]];
                                        }
                                    }

                                    res = !!Object.keys(this.option).length;

                                    if (el && res && this.callback) {
                                        el.innerHTML = this.callback.apply(null, this.params).replace(/^<li\b[^>]*>|<\/li>$/g, "");
                                    }

                                    return res;
                                }
                            }
                        ],
                        success: {
                            title: "הסגנון שלך הוא {0}",
                            button: "להורדת חוברת הסגנון"
                        },
                        final: {
                            A: {
                                title: "יצירתי",
                                value: "1dl0GD7_hE4HgAwybk9wSbn_bke47V0cZ"
                            },
                            B: {
                                title: "דרמטי",
                                value: "1c4WdteW3cNCkpHWzHKmCPRtJsZvT_hKI"
                            },
                            C: {
                                title: "רומנטי",
                                value: "1MHFG3yneMT4H0FJOAVi_pqNlpjMQG7F7"
                            },
                            D: {
                                title: "קלאסי",
                                value: "1nWiD5zvvmDDsuaL_cMGvkBsWow0FuYPl"
                            },
                            E: {
                                title: "טבעי",
                                value: "1d8t_zlmBV8A6x8zVmdgG-YnQVm4JgoQd"
                            },
                            F: {
                                title: "בוהומייני",
                                value: "1uoqQj_hfra3Vp7ovrdQwVBgI2ga21HRR"
                            },
                            G: {
                                title: "קז'ואל",
                                value: "1Zxt08RVGwgyvCFBxt6v-U7pnuEWNx-g-"
                            }
                        }
                    }
                }
            },
            "magic-closet": {
                title: "ארון הקסמים",
                video: "GLQhGx2ULRo",
                download: {
                    title: "להורדת חוברת ארון הקסמים",
                    value: "1Ee5Zh92agzw6qkRsKE40t4zpwiw-DQTg"
                }
            },
            "modular-outfit": {
                title: "יש לך מה ללבוש",
                video: "_VYx-UC-VqU",
                download: {
                    title: "להורדת חוברת מערכת פריטי הבסיס",
                    value: "1kTlj1ZOXh8YQQyJCRuwBoShIfGKkUpLp"
                }
            },
            accessories: {
                title: "התוספת שתופסת",
                video: "fOYZbRKMYAE",
                pages: {
                    "covers-shoes": {
                        type: "video",
                        title: "סרטון: מטפחות ונעליים",
                        value: "JWTBhFri44w",
                        download: {
                            title: "להורדת חוברת האקססוריז",
                            value: "1wPOeaV2Y1xKnOsoOR1VevgU-g0L95cGO"
                        }
                    }
                }
            },
            lingerie: {
                title: "יסודות למראה חטוב",
                video: "qk0-_Dnf3Z4",
                pages: {
                    material: {
                        type: "video",
                        title: "סרטון: צבע, בד וגזרה בהלבשה תחתונה",
                        value: "IpwM9HEeup4",
                        download: {
                            title: "להורדת חוברת הלבשה התחתונה",
                            value: "1E8QTzqkLoWk23ht-BUCHt77QRoYCOuhc"
                        }
                    }
                }
            } /* ,
            bonuses: {
                title: "בונוסים",
                date: {
                    // Enabled 3w from registration date
                    interval: 3,
                    format: "..."
                },
                generateHTML: function () {
                    "use strict";

                    function addMonths(isoDate, numberMonths) {
                        // Resource https://stackoverflow.com/questions/5645058/how-to-add-months-to-a-date-in-javascript#13633692
                        var dateObject = new Date(isoDate),
                            day = dateObject.getDate(),
                            formatDate = ui.academy.formatDate;

                        // avoid date calculation errors
                        dateObject.setHours(20);

                        // add months and set date to last day of the correct month
                        dateObject.setMonth(dateObject.getMonth() + numberMonths + 1, 0);

                        // set day number to min of either the original one or last day of month
                        dateObject.setDate(Math.min(day, dateObject.getDate()));

                        return formatDate(dateObject.getDate()) + "/" + formatDate(dateObject.getMonth() + 1) + "/" + dateObject.getFullYear();
                    }

                    return "<div class=\"form bonuses\">" +
                        "    <h1><a href=/shopping target=_blank>סיבוב קניות - הנחה 50% בתוקף עד " + addMonths(ui.academy.data.startDate, 5) + "</a></h1>" +
                        "</div>";
                }
            } */
        }
    },
    hash: {},
    getIcon: function (name) {
        "use strict";

        return "<svg class=icon-" + name + "><use xlink:href=#" + name + " /></svg>";
    },
    generateDownloadLink: function (id, title) {
        "use strict";

        /* Download PDF
        PDF file as is https://drive.google.com/uc?export=download&id={ id }
        From Slides https://docs.google.com/presentation/d/{ id }/export/pdf */
        return "<a class=button href=\"https://drive.google.com/uc?export=download&id=" + id + "\" rel=noopener target=_blank tabindex=0>" + this.getIcon("download") + title + "</a>";
    },
    formatDate: function (number) {
        "use strict";

        // Leading zero https://stackoverflow.com/questions/6040515/how-do-i-get-month-and-date-of-javascript-in-2-digit-format#6040556
        return ("0" + number).slice(-2);
    },
    session: (function () {
        "use strict";

        function getData(sessionName, callback) {
            var result = {};

            try {
                result = JSON.parse(localStorage[sessionName]);
            } catch (e) {
                delete localStorage[sessionName];
            }

            if (typeof callback === "function") {
                return callback(result);
            }

            return result;
        }

        // localStorage renaming backwards compatibility, 2017/04/30
        return getData("session", function (session) {
            if (session.email && session.token) {
                return session;
            }

            return getData("user", function (user) {
                if (user.email && user.token) {
                    localStorage.session = localStorage.user;

                    delete localStorage.user;
                    ui.setUser(user);
                }

                return user;
            });
        });
    }()),
    endpoint: (function () {
        "use strict";

        var parts = location.host.split(".");

        while (parts.length > 2) {
            parts.shift();
        }

        return "https://lab." + parts.join(".") + "/webhook";
    }()),
    dataset: function (el, prop) {
        "use strict";

        if (el && el.nodeType === 1) {
            return el.dataset ? el.dataset[prop] : el.getAttribute("data-" + prop);
        }
    },
    select: function (el, avoidRedirect) {
        "use strict";

        if (el) {
            var hash = {
                session: this.dataset(el, "session"),
                page: this.dataset(el, "page")
            };

            if ((this.hash.session === hash.session) &&
                (this.hash.page === hash.page)) {
                el.classList.add("expand");
            } else {
                hash = ui.serialize(hash);

                if (!avoidRedirect && hash) {
                    location.hash = hash;
                    ui.d.body.scrollTop = 0;
                } else if (!hash && location.hash || !this.data.session[ui.hash("session")]) {
                    location.hash = "";

                    if (history.replaceState) {
                        history.replaceState("", ui.d.title, location.pathname);
                    }
                }
            }
        }
    },
    refresh: function (stripHash) {
        "use strict";

        if (stripHash) {
            ui.w.location = location.pathname;
        } else {
            location.reload();
        }
    },
    login: function (e) {
        "use strict";

        e.preventDefault();
        ui.form.accessibility(false, null, true);

        var self = this;

        fetch(self.endpoint + "/login", {
            method: "POST",
            // Prevent insecure redirects https://developer.mozilla.org/en-US/docs/Web/API/Response/redirected
            redirect: "error",
            body: JSON.stringify({
                email: self.email.value.toLowerCase(),
                pass: self.pass.value
            })
        }).then(function (response) {
            return response.json();
        }).then(function (json) {
            self.updateSession(json);
            self.pushSW({status: "login"});
            ui.setUser(json);
            ui.form.accessibility(true, null, true);

            if (json.email && json.token) {
                self.refresh();
            } else if (self.button) {
                self.button.classList.add("error");
                self.button.innerHTML = "הפרטים שגויים, נסי שוב";
            }
        }).catch(function () {
            ui.form.accessibility(true, null, true);

            if (self.button) {
                self.button.classList.add("error");
                self.button.innerHTML = "טעות במערכת, נסי שוב מאוחר יותר";
            }
        });
    },
    forgot: function () {
        "use strict";

        ui.form.el.setAttribute("onsubmit", "ui.academy.remind(event)");
        this.email.focus();
        this.pass.parentNode.remove();
        this.button.innerHTML = "שלח לי סיסמא";
        this.button.classList.remove("error");
        this.link.innerHTML = "לנסות להתחבר מחדש";
        this.link.setAttribute("onclick", "ui.academy.refresh(true)");
    },
    remind: function (e) {
        "use strict";

        e.preventDefault();
        ui.form.accessibility(false, null, true);

        var self = this;

        fetch(self.endpoint + "/forgot", {
            method: "POST",
            redirect: "error",
            body: JSON.stringify({
                email: self.email.value.toLowerCase()
            })
        }).then(function (response) {
            return response.json();
        }).then(function (data) {
            ui.form.accessibility(true, null, true);

            if (data.success) {
                ui.form.el.innerHTML = "<h2>פרטי גישה נשלחו למייל שלך</h2><a onclick=ui.academy.refresh(true)>לנסות להתחבר</a>";
            } else {
                self.button.classList.add("error");
                self.button.innerHTML = "מייל לא רשום, נסי שוב";
            }
        }).catch(function () {
            ui.form.accessibility(true, null, true);

            if (self.button) {
                self.button.classList.add("error");
                self.button.innerHTML = "טעות במערכת, נסי שוב מאוחר יותר";
            }
        });
    },
    logout: function (preventPushSW) {
        "use strict";

        delete localStorage.session;

        if (!preventPushSW) {
            this.pushSW({status: "logout"});
        }

        this.refresh(true);
    },
    date: function (options) {
        "use strict";

        options = options || {};

        if (!this.currentTime) {
            this.firstSession = true;
        } else if (this.firstSession) {
            delete this.firstSession;
        }

        this.currentTime = !options.interval && this.currentTime || new Date(this.data.startDate);
        var date = new Date(this.currentTime.setDate(this.currentTime.getDate() +
                (options.interval ? options.interval * this.data.interval :
                    (this.firstSession ? 0 : this.data.interval))) +
                (options.interval ? 0 : 10000000));

        date.setHours(0, 0, 0, 0);

        return {
            enabled: +date <= +new Date,
            format: options.format || this.formatDate(date.getDate()) + "/" + this.formatDate(date.getMonth() + 1)
        };
    },
    key: function (e) {
        "use strict";

        if (e && e.target && (e.keyCode || e.which) === 13) {
            e.preventDefault();
            e.target.click();
        }
    },
    events: function (session, page) {
        "use strict";

        return " onclick=ui.academy.select(this) onkeydown=ui.academy.key(event)" +
            (session ? " data-session=" + session : "") + (page ? " data-page=" + page : "") +
            " tabindex=" + (page ? -1 : 0);
    },
    isLogged: function () {
        "use strict";

        this.data.startDate = +new Date((this.session.startDate || this.session.created) * 1000).setHours(0, 0, 0, 0);

        ui.d.documentElement.classList.remove("stretch");
        ui.d.documentElement.classList.add("logedin");
        this.details.remove();

        this.account = ui.d.getElementById("account");
        this.account.outerHTML = "<div class=profile>" +
            "    <img src=\"https://gravatar.com/avatar/" + this.session.avatar + "?s=42&r=g&d=mm\">" +
            "    <div class=\"table center\">" +
            "        <div class=cel>" +
            (this.session.firstName ? "            <div class=nowrap dir=auto>" + this.session.firstName + "</div>" : "") +
            "            <small onclick=ui.academy.logout()>התנתקי</small>" +
            "        </div>" +
            "    </div>" +
            "</div>";

        delete this.details;
        delete this.account;

        var obj = this.data.init,
            current = ui.hash("session"),
            result = "",
            session,
            pages,
            page,
            date;

        result += "<div class=\"column nav-container\" id=sidenav role=navigation dir=ltr>" +
            "<div class=sidenav dir=rtl>" +
            "    <a class=active" + this.events() + "><label>" + (obj.shortTitle || obj.title) + "</label></a>" +
            "</div>";

        obj = this.data.session;

        result += "<ol class=sidenav dir=rtl>";

        for (session in obj) {
            if (obj.hasOwnProperty(session)) {
                date = this.date(obj[session].date);
                result += "    <li" + (session === current ? " class=expand" : "") + ">" +
                    "<label" + (date.enabled ? this.events(session) : " disabled") + ">" +
                    "<time>" + date.format + "</time><div>" + obj[session].title + "</div>" +
                    "</label>";
                pages = obj[session].pages;

                if (pages && date.enabled) {
                    result += "<ol>";

                    for (page in pages) {
                        if (pages.hasOwnProperty(page)) {
                            result += "    <li><a class=unselectable" + this.events(session, page) + ">" + pages[page].title.replace(/\n/g, " ") + "</a>";
                        }
                    }

                    result += "</ol>";
                }
            }
        }

        result += "</ol>" +
            "</div>" +
            "<div class=\"column content\" id=content></div>";

        this.content.outerHTML = "<div class=container>" + result + "</div>";
        this.content = ui.d.getElementById("content");
        this.sidenav = ui.d.getElementById("sidenav");

        this.toggleNav(true);
    },
    /* list: function (obj, session, page) {
        "use strict";

        var url = "";

        if (obj.value) {
            switch (obj.type) {
                case "video":
                    url = ui.video.youtubeSupport ? "https://img.youtube.com/vi/" + obj.value + "/maxresdefault.jpg" : ui.video.getData(obj.value).image;
                    break;
                case "document":
                case "calculator":
                    // Params https://pgenom.com/community/threads/гуглодиск-как-хостинг-картинок-файловый-хостинг.1236/
                    url = "https://drive.google.com/thumbnail?authuser=0&sz=w640&id=" + obj.value;
                    break;
                case "sat":
                case "qa":
                    url = "/assets/" + obj.value;
                    break;
                default:
                    url = "";
            }
        }

        // YouTube image sizes http://stackoverflow.com/questions/2068344
        return obj ? "<a class=\"absolute cover\"" + this.events(session, page) +
            " style=\"background-image:url(" + url + ")\"><h3 class=nowrap dir=auto>" +
            obj.title.replace(/\n/g, " ") + "</h3></a>" : "";
    }, */
    uniqueID: function () {
        "use strict";

        return Math.random().toString(16).substr(2, 8);
    },
    qa: function (obj) {
        "use strict";

        var self = this;

        function label(data, index, sameLoop) {
            var skipLoop = index !== false,
                result = "",
                final,
                key,
                id;

            index = index || 0;

            if (skipLoop && !sameLoop) {
                index += 1;
            }
            if (data) {
                if (skipLoop) {
                    final = !data.option;
                    id = !final && self.uniqueID();
                    result += (sameLoop ? "" : "<ol>") +
                        "<li><input type=radio name=" + index + (id ? " id=" + id : "") + ">" +
                        "<label onclick=" +
                        (data.final ?
                            "\"ui.academy.qa.dialog(event, " + index + ", '" + data.final + "')\"" :
                            "ui.academy.qa.click(event) for=" + id) +
                        ">" + self.getIcon("check") + data.title + "</label>";
                }
                if (Array.isArray(data.option)) {
                    index += 1;
                    result += "<ol>";

                    for (key in data.option) {
                        if (data.option.hasOwnProperty(key)) {
                            result += label(data.option[key], index, true);
                        }
                    }

                    result += "</ol>";
                } else if (data.option) {
                    result += label(data.option, index);
                }
                if (skipLoop) {
                    result += "</li>" +
                        (sameLoop ? "" : "</ol>");
                }
            }

            return result;
        }

        this.qa.click = function (e) {
            var el = e.target.tagName === "LABEL" ? e.target : e.target.closest("label"),
                active = el.getAttribute("data-active") === "true",
                arrB,
                arr,
                i,
                o;

            if (active) {
                e.preventDefault();

                arr = el.parentNode.querySelectorAll("[data-active]");

                for (i = 0; i < arr.length; i += 1) {
                    arr[i].removeAttribute("data-active");
                }

                arr = el.parentNode.querySelectorAll("input:checked");

                for (i = 0; i < arr.length; i += 1) {
                    arr[i].checked = false;
                }
            } else {
                el.setAttribute("data-active", "true");
            }

            arr = el.parentNode.parentNode.children;

            for (i = 0; i < arr.length; i += 1) {
                if (!active && arr[i] === el.parentNode) {
                    el.removeAttribute("disabled");
                } else {
                    arrB = arr[i].querySelectorAll("label");

                    for (o = 0; o < arrB.length; o += 1) {
                        if (active) {
                            arrB[o].removeAttribute("disabled");
                        } else {
                            arrB[o].setAttribute("disabled", "");
                        }
                    }
                }
            }
        };
        this.qa.dialog = function (e, index, type, finalEl) {
            var el = finalEl || e.target,
                data = obj.final[type],
                result = "";

            if (!finalEl && e) {
                this.click(e);
            }
            if (el && data) {
                result += "<div class=\"dialog" + (finalEl ? " final" : "") + "\">" +
                    "   <div class=table>" +
                    "   <div class=cel>" +
                    (finalEl ? "" : "       <div class=close onclick=ui.academy.qa.reset(this) tabindex=0>" + self.getIcon("close") + "</div>") +
                    "       <h1 class=nowrap>" + data.title + "</h1>" +
                    (finalEl ? "" : "       <p>שימי לב, אחרי הורדה לא ניתן לשנות קטגוריה</p>") +
                    "       <div>" +
                    (finalEl ? self.generateDownloadLink(data.value, "להורדת סרגל הצבעים") :
                        "<a class=button onclick=\"ui.academy.qa.final(this, '" + type + "')\" tabindex=0>לקבל סרגל צבעים</a>") +
                    "</div>" +
                    "   </div>" +
                    "   </div>" +
                    "</div>";

                if (!finalEl) {
                    el = index === 1 ? el.parentNode : el.parentNode.parentNode.parentNode;
                    el.insertAdjacentHTML("afterbegin", result);
                }
            }

            return result;
        };
        this.qa.reset = function (el) {
            if (el) {
                el.parentNode.parentNode.parentNode.remove();
            }

            var arr = ui.d.querySelectorAll(".qa [disabled]"),
                i;

            for (i = 0; i < arr.length; i += 1) {
                arr[i].removeAttribute("disabled");
            }

            arr = ui.d.querySelectorAll(".qa input:checked");

            for (i = 0; i < arr.length; i += 1) {
                arr[i].checked = false;
            }

            arr = ui.d.querySelectorAll(".qa [data-active]");

            for (i = 0; i < arr.length; i += 1) {
                arr[i].removeAttribute("data-active");
            }
        };
        this.qa.final = function (el, value) {
            var type = "update",
                data = {
                    email: self.session.email,
                    token: self.session.token,
                    data: {qa: value}
                },
                close = ui.d.querySelector(".qa .close");

            if (close) {
                close.remove();
            }

            ui.form.accessibility(false, ui.d.querySelector(".qa"), true);

            fetch(self.endpoint + "/" + type, {
                method: "POST",
                redirect: "error",
                body: JSON.stringify(data)
            }).then(function (response) {
                return response.json();
            }).then(function (json) {
                return json.error ? Promise.reject(json) : json;
            }).then(function (json) {
                self.updateSession(json);
                self.refresh();
            }).catch(function () {
                if (el) {
                    el.remove();
                }

                self.reportError(type, data);
            });
        };

        return "<div class=\"form qa\">" +
            "    <h1>" + obj.title.replace(/\n/g, "<br>") + "</h1>" +
            (this.session.task && this.session.task.qa ? this.qa.dialog(null, 0, this.session.task.qa, true) : label(obj, false)) +
            "</div>";
    },
    submit: function (o, post) {
        "use strict";

        var e = o instanceof Event && o,
            el = o && o.target || o,
            self = this,
            type,
            data,
            page;

        if (e) {
            e.preventDefault();
        }
        if (ui.form.valid(ui.form.list("[data-required]", el))) {
            page = ui.hash("page");
            data = {
                email: self.session.email,
                token: self.session.token,
                data: {}
            };

            ui.form.accessibility(false, el, true, page === "sat" && "label");

            switch (page) {
                case "calculator":
                    data.data[page] = (function () {
                        post = ui.form.deserialize(el);
                        var A = post.A,
                            B = post.B,
                            C = post.C,
                            D = post.D,
                            tolerance = 8,
                            comp = function (a, b) {
                                // Compare with tolerance
                                return a === false ? false : Math.abs((a || 0) - (b || 0)) <= (tolerance || 0);
                            },
                            button,
                            status;

                        if (comp(A, B) && comp(A, C) && comp(A, D) && comp(B, C) && comp(B, D) && comp(C, D)) {
                            return "square";
                        } else if (comp(A, B) && (A > C && !comp(A, C) || B > C && !comp(B, C))) {
                            return "hourglass";
                        } else if ((A > B && !comp(A, B)) || (D > B && !comp(D, B))) {
                            return "invertedTriangle";
                        } else if (A < B && !comp(A, B)) {
                            return "triangle";
                        } else if (comp(A, B) && (A < C && !comp(A, C) || B < C && !comp(B, C))) {
                            return "rounded";
                        }

                        // C > D
                        ui.form.accessibility(true, el, true);

                        button = el.querySelector("button");
                        status = el.querySelector("[data-status]");

                        if (status) {
                            status.innerHTML = "<b>" + self.data.session["body-shape"].pages[page].error.format("<a href=\"/contact#diy\" target=_blank>", "</a>") + "</b>";
                            status.classList.add("error");
                        }
                        if (button) {
                            button.classList.add("error");
                        }
                    }());
                    break;
                case "sat":
                    data.data[page] = post;
                    el.closest("[data-handler]")
                        .querySelector("[data-back]")
                        .remove();
            }

            if (data.data[page]) {
                type = "update";

                fetch(self.endpoint + "/" + type, {
                    method: "POST",
                    redirect: "error",
                    body: JSON.stringify(data)
                }).then(function (response) {
                    return response.json();
                }).then(function (json) {
                    return json.error ? Promise.reject(json) : json;
                }).then(function (json) {
                    self.updateSession(json);
                    self.refresh();
                }).catch(function () {
                    self.reportError(type, data);
                });
            }
        }
    },
    calculator: function (obj) {
        "use strict";

        var result = "",
            arr,
            i;

        if (this.session.task && this.session.task.calculator && obj.final[this.session.task.calculator]) {
            // Google docs links http://blog.appsevents.com/2014/04/how-to-bypass-google-drive-viewer-and.html
            result = "<div class=\"dialog final\">" +
                "   <div class=table>" +
                "   <div class=cel>" +
                "       <h1>" + obj.result.format(obj.final[this.session.task.calculator].title) + "</h1>" +
                "       <div>" + this.generateDownloadLink(obj.final[this.session.task.calculator].value, obj.download) + "</div>" +
                "   </div>" +
                "   </div>" +
                "</div>";
        } else {
            arr = Object.keys(obj.option);

            for (i = 0; i < arr.length; i += 1) {
                result += "<li class=row>" +
                    "    <label class=\"column label\" for=" + arr[i] + ">" + obj.option[arr[i]] + "</label>" +
                    "    <div class=column><input id=" + arr[i] + " name=" + arr[i] + " type=number inputmode=numeric min=50 max=200 maxlength=3 data-required" + (i ? "" : " autofocus") + "></div>" +
                    "</li>";
            }

            result = "<form onsubmit=ui.academy.submit(event) method=post novalidate>" +
                "    <ul class=sheet>" + result + "</ul>" +
                "    <div data-status><small><i>" + obj.notice + "</i></small></div>" +
                "    <button>" + obj.button + "</button>" +
                "</form>";
        }

        return "<div class=\"form calculator\">" +
            "    <h1>" + obj.title.replace(/\n/g, "<br>") + "</h1>" + result +
            "</div>";
    },
    sat: {
        ui: function (obj) {
            "use strict";

            var self = ui.academy,
                result = "",
                index = 0,
                sum = [],
                calculate,
                prefixer,
                option,
                group,
                title,
                links,
                form;

            calculate = function (arr) {
                // http://www.jstips.co/en/javascript/flattening-multidimensional-arrays-in-javascript/
                var flattenArray = [].concat.apply([], arr),
                    // http://stackoverflow.com/questions/840781/#24968449
                    sumObject = flattenArray.map(function (item) {
                        if (typeof item === "object" && item.final) {
                            return {
                                // Largest count, is the final result
                                count: arr.length + 1,
                                name: item.final
                            };
                        }

                        return {
                            count: 1,
                            name: item
                        };
                    }).reduce(function (a, b) {
                        a[b.name] = (a[b.name] || 0) + b.count;

                        return a;
                    }, {}),
                    keys = Object.keys(sumObject),
                    largest = Math.max.apply(null, keys.map(function (x) {
                        return sumObject[x];
                    })),
                    res = keys.reduce(function (val, key) {
                        if (sumObject[key] === largest) {
                            val.push(key);
                        }

                        return val;
                    }, []);

                if (res.length > 2) {
                    return ["A"];
                } else if (res.length === 2) {
                    // Compare Arrays https://stackoverflow.com/questions/7837456/how-to-compare-arrays-in-javascript#42186143
                    switch (JSON.stringify(res).replace(/[[,\]]/g, "")) {
                        case "AB":
                        case "AC":
                        case "AD":
                        case "AE":
                            return ["A"];
                        case "BC":
                        case "BD":
                        case "BE":
                            return ["B"];
                        case "CE":
                            return ["F"];
                        case "DE":
                            return ["G"];
                    }
                }

                return res;
            };

            if (self.session.task && self.session.task.sat && self.session.task.sat.length) {
                calculate = calculate(self.session.task.sat);
                title = obj.success.title.format(calculate.map(function (x) {
                    return obj.final[x].title;
                }).join(" "));
                links = calculate.map(function (x) {
                    return self.generateDownloadLink(obj.final[x].value, obj.success.button);
                }).join("");
                result = "<div class=\"dialog final\">" +
                    "   <div class=table>" +
                    "   <div class=cel>" +
                    "       <h1>" + title + "</h1>" +
                    "       <div>" + links + "</div>" +
                    "   </div>" +
                    "   </div>" +
                    "</div>";
            } else {
                prefixer = function (prop) {
                    var prefixes = ["Webkit", "Moz", "ms"],
                        style = ui.d.documentElement.style,
                        vendorProp,
                        i;

                    if (prop) {
                        prop = prop.toLowerCase().replace(/-([a-z])/g, function (a, b) {
                            return b.toUpperCase();
                        });

                        if (prop in style) {
                            return prop;
                        }

                        prop = prop.charAt(0).toUpperCase() + prop.substr(1);

                        for (i = 0; i < prefixes.length; i += 1) {
                            vendorProp = prefixes[i] + prop;

                            if (vendorProp in style) {
                                return vendorProp;
                            }
                        }
                    }

                    return null;
                };
                this.navigate = function (el) {
                    if (el) {
                        var wrapper = ui.d.getElementById("slide"),
                            goNext = el.hasAttribute("data-next"),
                            schema = self.data.session.style.pages.sat.option;

                        if (goNext) {
                            if (index < schema.length - 1) {
                                index += 1;
                            }
                        } else {
                            if (sum[index] && !Array.isArray(sum[index])) {
                                sum.splice(index, 1);
                            }

                            index -= 1;
                        }

                        schema = schema[Math.abs(index)];

                        if (schema && typeof schema.condition !== "function" || schema.condition(calculate(sum))) {
                            if (wrapper) {
                                wrapper.style[prefixer("transform")] = "translateX(" + (100 * index) + "%)";
                            }
                        } else {
                            index -= 1;
                            this.done(el);
                        }
                    }
                };
                this.check = function (el) {
                    var handler = el.closest("[data-handler]"),
                        button = handler.querySelector("[data-next]"),
                        maxCount = handler.getAttribute("data-max"),
                        data = ui.form.deserialize(handler),
                        keys = Object.keys(data),
                        count = keys.length,
                        toggleAttribute,
                        i;

                    maxCount = maxCount ? Number(maxCount) - 1 : 1;
                    toggleAttribute = function (arr) {
                        for (i = 0; i < arr.length; i += 1) {
                            if (count > maxCount) {
                                arr[i].setAttribute("disabled", "");
                            } else {
                                arr[i].removeAttribute("disabled");
                            }
                        }
                    };

                    if (keys.length) {
                        sum[index] = maxCount === 0 ? {final: keys[0]} : keys;
                    } else if (sum[index] && !Array.isArray(sum[index])) {
                        sum.splice(index, 1);
                    }
                    if (count) {
                        button.removeAttribute("disabled");
                    } else {
                        button.setAttribute("disabled", "");
                    }

                    toggleAttribute(ui.form.list("input:not(:checked)", handler));
                    toggleAttribute(ui.form.list("input:not(:checked) ~ label", handler));
                };
                this.done = function (el) {
                    self.submit(el.closest("[data-handler]"), sum);
                };
                option = function (key, name, showImage) {
                    var id = self.uniqueID();

                    name = typeof name === "object" ? name.title : name;

                    return "<li" + (showImage ? " class=box" : "") + ">" +
                        "    <input name=" + key + " id=" + id + " onclick=ui.academy.sat.check(this) type=checkbox>" +
                        (showImage ? "<figure><img class=absolute src=/assets/academy-style-" + key.toLowerCase() + ".jpg alt=\"" + name + "\"></figure>" : "") +
                        "    <label class=\"column label wrap\" for=" + id + ">" + ui.academy.getIcon("check") + name + "</label>" +
                        "</li>";
                };
                group = function (data, n, len) {
                    var arr = Object.keys(data.option || {}),
                        res = "",
                        id = "",
                        i;

                    for (i = 0; i < arr.length; i += 1) {
                        res += option(arr[i], data.option[arr[i]], data.showImage);
                    }

                    if (!data.hasOwnProperty("option")) {
                        data.callback = group;
                        data.params = arguments;
                        data.id = self.uniqueID();
                        id = " id=" + data.id + " data-max=1";
                    }

                    return "<li class=qa" + id + " data-handler>" +
                        "    <h4 class=wrap>" + n + ". " + data.title + "</h4>" +
                        "    <small class=wrap><i>" + (data.limit || obj.limit) + "</i></small>" +
                        "    <ol" + (data.showImage ? " class=grid" : "") + ">" + res + "</ol>" +
                        (n === len ?
                            "    <button class=next onclick=ui.academy.sat.done(this) data-next disabled>" + obj.button + "</button>" :
                            "    <button class=next onclick=ui.academy.sat.navigate(this) data-next disabled>" + obj.next + "</button>") +
                        (n > 1 ? "    <span class=\"back unselectable\" onclick=ui.academy.sat.navigate(this) data-back>" + obj.back + "</span>" : "") +
                        "</li>";
                };
                form = function (data) {
                    var arr = data.option,
                        res = "",
                        i;

                    for (i = 0; i < arr.length; i += 1) {
                        res += group(arr[i], i + 1, arr.length);
                    }

                    return res;
                };

                result = "<form onsubmit=event.preventDefault() method=post novalidate>" +
                    "    <ul class=\"sheet wrapper\" id=slide>" + form(obj) + "</ul>" +
                    "</form>";
            }

            return "<div class=\"form sat\">" +
                "    <h1>" + obj.title.replace(/\n/g, "<br>") + "</h1>" + result +
                "</div>";
        }
    },
    videoTemplate: function (obj) {
        "use strict";

        var id = obj.value || obj.video,
            buttons = "",
            prop;

        if (obj.pages) {
            for (prop in obj.pages) {
                if (obj.pages.hasOwnProperty(prop)) {
                    buttons += "<a class=button href=\"#session=" + ui.hash("session") + "&page=" + prop + "\" tabindex=0>" + obj.pages[prop].title + "</a> ";
                }
            }
        }
        if (obj.download) {
            buttons += this.generateDownloadLink(obj.download.value, obj.download.title);
        }

        return "<div class=video>" +
            (ui.video.youtubeSupport ?
                "<iframe src=\"https://www.youtube.com/embed/" + id + "\"  allow=\"autoplay; encrypted-media; fullscreen\" allowfullscreen></iframe>" :
                ui.video.template(id)) +
            "</div>" +
            "<div class=space><h1>" + obj.title + "</h1>" + buttons + "</div>";
    },
    pageSession: function () {
        "use strict";

        var hash = ui.hash(),
            result = "",
            // prop,
            obj;

        if (this.valid && this.content) {
            this.self = hash.session ? this.data.session[hash.session] :
                (location.href.indexOf("#") === -1 || !location.hash && !history.replaceState ? this.data.init : null);

            if (this.self && (!hash.session || !this.sidenav ||
                this.sidenav.querySelector("[data-session=\"" + hash.session + "\"]:not([data-page])"))) {
                obj = this.self;

                if (this.bar && this.bar.checked) {
                    this.bar.checked = false;
                }
                if (obj) {
                    if (!hash.session || hash.session && !hash.page) {
                        if (obj.video) {
                            result += this.videoTemplate(obj);
                        }
                        if (typeof obj.generateHTML === "function") {
                            result += obj.generateHTML();
                        }

                        // result += "<ol class=items dir=ltr>";

                        // for (prop in obj) {
                        //     if (obj.hasOwnProperty(prop)) {
                        //         result += "    <li>" + this.list(obj[prop], hash.session, prop) + "</li>";
                        //     }
                        // }

                        // result += "</ol>";
                    } else {
                        obj = hash.session ? obj && obj.pages && obj.pages[hash.page] : obj;

                        if (obj && obj.type) {
                            switch (obj.type) {
                                case "video":
                                    result += this.videoTemplate(obj);
                                    break;
                                // case "document":
                                //     // Usage example
                                //     //     "check-list": {
                                //     //         type: "document",
                                //     //         title: "צ'ק ליסט למערכת לבוש יעילה",
                                //     //         value: "1eSQaxVn2AKrwwrNafS0JnKTwjJzs50-7edCKn8kwkVs",
                                //     //         download: "https://docs.google.com/document/d/{0}/export?format=pdf"
                                //     //     }
                                //     // width="640" height="480"
                                //     // http://blog.appsevents.com/2014/04/how-to-bypass-google-drive-viewer-and.html
                                //     result += "<div class=video>" +
                                //         "    <iframe src=\"https://drive.google.com/file/d/" +
                                //             obj.value + "/preview\" allow="autoplay; encrypted-media; fullscreen" allowfullscreen></iframe>" +
                                //         "</div>" +
                                //         "<div class=space>" +
                                //         "    <h1>" + obj.title + "</h1>" +
                                //         "    <a class=button href=\"" + (obj.download ? obj.download.format(obj.value) :
                                //             this.getDownloadLink(obj.value)) +
                                //             "\" rel=noopener target=_blank tabindex=0><b>להורדת " + obj.title + "</a>" +
                                //         "</div>";
                                //     break;
                                case "calculator":
                                case "sat":
                                case "qa":
                                    result += this[obj.type].ui ? this[obj.type].ui(obj) : this[obj.type](obj);
                                    break;
                            }

                            this.self = obj;
                        }
                    }

                    this.content.innerHTML = result;

                    if (obj) {
                        if (obj.video || obj.type === "video") {
                            ui.video.applyPlyr();
                        }
                        if (ui.comment) {
                            ui.comment.load(this.content);
                        }
                    } else if (ui.comment) {
                        ui.comment.remove();
                    }
                }
            } else {
                delete this.self;
                this.refresh(true);
            }
        }
    },
    toggleNavClassName: function (el) {
        "use strict";

        var hash = ui.hash(),
            resetElement = {
                session: this.sidenav && this.sidenav.querySelector(".expand"),
                active: this.sidenav && this.sidenav.querySelector(".active"),
                page: this.sidenav && this.sidenav.querySelector(".selected")
            },
            applyClass,
            diff;

        hash.previous = {
            session: this.dataset(resetElement.session, "session"),
            page: this.dataset(resetElement.page || resetElement.active, "page")
        };
        applyClass = function (key, className, forceApplyClass) {
            if (forceApplyClass || hash.previous[key] !== hash[key]) {
                if (resetElement[key]) {
                    resetElement[key].classList.remove(className);

                    if (resetElement[key].nextElementSibling && resetElement[key].nextElementSibling.tagName === "OL") {
                        ui.form.list("a", resetElement[key].nextElementSibling).forEach(function (a) {
                            a.tabIndex = -1;
                        });
                    }

                    if (ui.d.activeElement === resetElement[key]) {
                        resetElement[key].blur();
                    }
                }
                if (!diff) {
                    diff = true;
                }
                if (el) {
                    el.classList.add(className);

                    if (el.nextElementSibling && el.nextElementSibling.tagName === "OL") {
                        ui.form.list("a", el.nextElementSibling).forEach(function (a) {
                            a.tabIndex = 0;
                        });
                    }
                }
            }
        };

        applyClass("session", "expand");
        applyClass("page", "selected", !!diff);
        applyClass("active", "active", !!diff);
    },
    toggleNav: function (initLoad) {
        "use strict";

        var self = ui.academy,
            obj,
            arr;

        self.hash = ui.hash();

        if (self.sidenav) {
            obj = location.hash ? self.data.session[self.hash.session] : self.data.init;

            if (obj) {
                self.toggleNavClassName(self.sidenav.querySelector(location.hash ?
                    "[data-session=\"" + self.hash.session + "\"]:not([data-page])" : "a"));

                if (obj.pages && obj.pages[self.hash.page]) {
                    self.toggleNavClassName(self.sidenav.querySelector("[data-session=\"" +
                        self.hash.session + "\"][data-page=\"" + self.hash.page + "\"]"));
                }
            }
            if (initLoad === true && !location.hash) {
                arr = self.sidenav.querySelectorAll("[data-session]:not([data-page])");

                self.toggleNavClassName(arr[arr.length - 1]);
            }
        }

        self.pageSession();
    },
    sessionError: function () {
        "use strict";

        if (sessionStorage.sessionError) {
            var el = ui.d.getElementById("session-error");

            if (el) {
                el.hidden = false;
                el.innerHTML = sessionStorage.sessionError;
                delete sessionStorage.sessionError;
            }
        }
    },
    reportError: function (type, data) {
        "use strict";

        if (ui.environment === "prod") {
            if ("sendBeacon" in navigator) {
                navigator.sendBeacon(this.endpoint + "/error", JSON.stringify({
                    schema: type,
                    email: this.session.email,
                    log: JSON.stringify(data, null, 2)
                }));
            }
        } else {
            console.error(type, data);
        }

        // Your session has expired, please login again
        sessionStorage.sessionError = "זהינו שלא פעלת בחשבונך בדקות האחורנות. אנה התחברי שוב.";

        delete localStorage.session;
        this.refresh();
    },
    updateSession: function (data, preventPushSW) {
        "use strict";

        if (typeof data === "object") {
            data.dataTime = data.dataTime || +new Date;

            if (!preventPushSW) {
                this.pushSW({
                    status: "update",
                    data: data
                });
            }

            this.session = data;
            localStorage.session = JSON.stringify(data);
        }
    },
    vertifySession: function (callback, force) {
        "use strict";

        if (!force && this.session.startDate &&
            +new Date() - Number(this.session.dataTime) < 86400000) {
            if (typeof callback === "function") {
                callback();
            }
        } else {
            var self = this,
                type = "vertify",
                data = {
                    email: self.session.email,
                    token: self.session.token
                };

            fetch(self.endpoint + "/" + type, {
                method: "POST",
                redirect: "error",
                body: JSON.stringify(data)
            }).then(function (response) {
                return response.json();
            }).then(function (json) {
                return json.error ? Promise.reject(json) : json;
            }).then(function (json) {
                self.updateSession(json);

                if (typeof callback === "function") {
                    callback();
                }
            }).catch(function () {
                self.reportError(type, data);
            });
        }
    },
    pushSW: function (data, fromOtherTab) {
        "use strict";

        if (typeof data === "object" && navigator.serviceWorker && navigator.serviceWorker.controller) {
            if (ui.environment === "dev") {
                console.log("ServiceWorker", data);
            }
            if (fromOtherTab) {
                switch (data.status) {
                    case "login":
                        return location.reload();
                    case "logout":
                        return this.logout(true);
                    case "update":
                        return this.updateSession(data.data, true);
                }
            } else {
                navigator.serviceWorker.controller.postMessage(data);
            }
        }
    },
    registerSW: function () {
        "use strict";

        if (location.protocol === "https:" && "serviceWorker" in navigator) {
            navigator.serviceWorker.register("/sw.js").then(function () {
                navigator.serviceWorker.addEventListener("message", function (e) {
                    if (e.data) {
                        ui.academy.pushSW(e.data, true);
                    }
                });
            });
        }
    },
    init: function () {
        "use strict";

        var self = this;

        ui.legacy(function () {
            var loading = ui.d.getElementById("loading");

            ui.form.el = ui.d.getElementById("form");
            self.bar = ui.d.getElementById("bar");
            self.button = ui.d.getElementById("button");
            self.content = ui.d.getElementById("content");
            self.details = ui.d.getElementById("details");
            self.email = ui.d.getElementById("email");
            self.link = ui.d.getElementById("link");
            self.pass = ui.d.getElementById("pass");
            self.valid = !!self.session.email && !!self.session.token;

            self.content.removeAttribute("hidden");
            self.details.removeAttribute("hidden");

            self.registerSW();

            if (loading) {
                loading.remove();
            }
            if (self.valid) {
                self.vertifySession(function () {
                    self.isLogged();
                    ui.identify.all();
                });
            } else if (self.session.email) {
                self.email.value = self.session.email;

                // setTimeout to avoid autofocus property
                setTimeout(function () {
                    self.pass.focus();
                }, 0);
            }

            ui.w.addEventListener("hashchange", self.toggleNav);
            self.sessionError();
        });
    }
};

ui.academy.init();

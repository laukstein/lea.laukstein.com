ui.payment=ui.legacy(function(){"use strict";var e,t;return e=function(){var e,a,n=ui.d.getElementById("status"),r=ui.d.pelepayform,i=ui.hash(),o=function(e){console.warn(i),n.innerHTML="<div class=error>"+e+"</div>"},s=function(e,t){return Object.keys(e).filter(function(a){return t(a,e)}).reduce(function(t,a){return t[a]=e[a],t},{})},c=location.search&&ui.hash({hash:location.search,param:"affiliate"}),u=location.search&&ui.hash({hash:location.search,param:"campaign"}),h=ui.serialize({orderid:i.orderid});ui.pageProgress=ui.pageProgress||n.innerHTML,n.innerHTML=ui.pageProgress,u&&(i.utm_campaign=u),c&&(i.utm_source=c),history.replaceState&&(location.search&&history.replaceState("",ui.d.title,location.pathname+location.hash),h&&h!==location.hash.substring(1)&&history.replaceState("",ui.d.title,location.pathname+"#"+h)),i.email&&(i.email=i.email.toLowerCase(),ui.setUser(s({email:i.email,tel:i.phone,firstName:i.firstname,lastName:i.lastname},function(e,t){return!!t[e]}))),i.orderid&&r?(a=function(){for(var e=location.host.split(".");e.length>2;)e.shift();return"https://lab."+e.join(".")+"/webhook"}(),e=["orderid","email","phone","firstname","lastname","utm_campaign","utm_source"],i=s(i,function(t){return e.includes(t)}),i.token=Math.random().toString(16).substr(2,8).toUpperCase(),t=i.token,fetch(a+"/payment",{method:"POST",redirect:"error",body:JSON.stringify(i)}).then(function(e){return i.token===t&&200===e.status&&e.json()}).then(function(e){var t=e.custom&&ui.hash({hash:atob(e.custom),param:"token"});return i.token!==t?Promise.reject(new Error("קישור תשלום לא קיים. לשאלות <a href=/contact>תצרי קשר</a")):(ui.payment=e,sessionStorage.paymentToken=t,Object.keys(e).forEach(function(t){var a=ui.d.createElement("input");a.type="hidden",a.name=t,a.value=e[t],r.appendChild(a)}),console.log("Payment "+e.orderid+" "+e.email),console.log(e),r.submit(),void 0)})["catch"](function(e){i.token===t&&o(e.message||"תקלה בשרת. לשאלות <a href=/contact>תצרי קשר</a>")})):o("קישור לא תקין. לשאלות <a href=/contact>תצרי קשר</a>")},ui.w.addEventListener("hashchange",e),e()});
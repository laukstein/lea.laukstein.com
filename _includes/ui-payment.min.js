ui.payment=ui.legacy(function(){"use strict";var e,t;return e=function(){var e,a,r=ui.d.getElementById("status"),o=ui.d.pelepayform,n=ui.hash(),i=function(e,t){t=t||{},"Failed to fetch"===t.message?(console.error(t.message),e="תקלה זמנית בשרת. תנסי שוב מאוחר יותר"):"NetworkError when attempting to fetch resource."===t.message?(console.error(t.message),e="תקלה בשרת. לשאלות <a href=/contact>צרי קשר</a>"):e=t.message||e,console.warn(n),r.innerHTML="<div class=error>"+e+"</div>"},s=location.search&&ui.hash({hash:location.search,param:"affiliate"}),c=location.search&&ui.hash({hash:location.search,param:"campaign"}),h=ui.serialize({orderid:n.orderid});ui.pageProgress=ui.pageProgress||r.innerHTML,r.innerHTML=ui.pageProgress,c&&(n.utm_campaign=c),s&&(n.utm_source=s),history.replaceState&&(location.search&&history.replaceState("",ui.d.title,location.pathname+location.hash),h&&h!==location.hash.substring(1)&&history.replaceState("",ui.d.title,location.pathname+"#"+h)),n.email&&(n.email=n.email.toLowerCase(),ui.setUser(ui.filterObj({email:n.email,tel:n.phone,firstName:n.firstname,lastName:n.lastname},function(e,t){return!!t[e]}))),n.orderid&&o?(a=function(){for(var e=location.host.split(".");e.length>2;)e.shift();return"https://lab."+e.join(".")+"/webhook"}(),e=["orderid","email","phone","firstname","lastname","utm_campaign","utm_source"],n=ui.filterObj(n,function(t){var a=e.includes(t)&&!/\*\|.*?\|\*/.test(n[t]);return a&&t.startsWith("utm_")&&console.log(t,n[t]),a}),n.token=Math.random().toString(16).substr(2,8).toUpperCase(),t=n.token,fetch(a+"/payment",{method:"POST",redirect:"error",body:JSON.stringify(n)}).then(function(e){return 200===e.status?n.token===t&&e.json():Promise.reject(new Error("Failed to fetch"))}).then(function(e){var t=e.custom&&ui.hash({hash:atob(e.custom),param:"token"});return n.token!==t?Promise.reject(new Error("קישור תשלום לא קיים. לשאלות <a href=/contact>צרי קשר</a")):(ui.payment=e,sessionStorage.paymentToken=t,Object.keys(e).forEach(function(t){var a=ui.d.createElement("input");a.type="hidden",a.name=t,a.value=e[t],o.appendChild(a)}),console.log("Payment "+e.orderid+" "+e.email),console.log(e),o.submit(),void 0)})["catch"](function(e){n.token===t&&i("תקלה בשרת. לשאלות <a href=/contact>צרי קשר</a>",e)})):i("קישור לא תקין. לשאלות <a href=/contact>צרי קשר</a>")},ui.w.addEventListener("hashchange",e),e()});
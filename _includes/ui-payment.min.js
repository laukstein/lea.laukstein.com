ui.payment=ui.legacy(function(){"use strict";var e,t;return e=function(){var e,a,r=ui.d.getElementById("status"),n=ui.d.pelepayform,o=ui.hash(),i=function(e,t){t=t||{},"Failed to fetch"===t.message?(console.error(t.message),e="תקלה זמנית בשרת. תנסי שוב מאוחר יותר"):"NetworkError when attempting to fetch resource."===t.message?(console.error(t.message),e="תקלה בשרת. לשאלות <a href=/contact>צרי קשר</a>"):e=t.message||e,console.warn(o),r.innerHTML="<div class=error>"+e+"</div>"},s=function(e,t){return Object.keys(e).filter(function(a){return t(a,e)}).reduce(function(t,a){return t[a]=e[a],t},{})},c=location.search&&ui.hash({hash:location.search,param:"affiliate"}),u=location.search&&ui.hash({hash:location.search,param:"campaign"}),h=ui.serialize({orderid:o.orderid});ui.pageProgress=ui.pageProgress||r.innerHTML,r.innerHTML=ui.pageProgress,u&&(o.utm_campaign=u),c&&(o.utm_source=c),history.replaceState&&(location.search&&history.replaceState("",ui.d.title,location.pathname+location.hash),h&&h!==location.hash.substring(1)&&history.replaceState("",ui.d.title,location.pathname+"#"+h)),o.email&&(o.email=o.email.toLowerCase(),ui.setUser(s({email:o.email,tel:o.phone,firstName:o.firstname,lastName:o.lastname},function(e,t){return!!t[e]}))),o.orderid&&n?(a=function(){for(var e=location.host.split(".");e.length>2;)e.shift();return"https://lab."+e.join(".")+"/webhook"}(),e=["orderid","email","phone","firstname","lastname","utm_campaign","utm_source"],o=s(o,function(t){var a=e.includes(t)&&!/\*\|.*?\|\*/.test(o[t]);return a&&t.startsWith("utm_")&&console.log(t,o[t]),a}),o.token=Math.random().toString(16).substr(2,8).toUpperCase(),t=o.token,fetch(a+"/payment",{method:"POST",redirect:"error",body:JSON.stringify(o)}).then(function(e){return 200===e.status?o.token===t&&e.json():Promise.reject(new Error("Failed to fetch"))}).then(function(e){var t=e.custom&&ui.hash({hash:atob(e.custom),param:"token"});return o.token!==t?Promise.reject(new Error("קישור תשלום לא קיים. לשאלות <a href=/contact>צרי קשר</a")):(ui.payment=e,sessionStorage.paymentToken=t,Object.keys(e).forEach(function(t){var a=ui.d.createElement("input");a.type="hidden",a.name=t,a.value=e[t],n.appendChild(a)}),console.log("Payment "+e.orderid+" "+e.email),console.log(e),n.submit(),void 0)})["catch"](function(e){o.token===t&&i("תקלה בשרת. לשאלות <a href=/contact>צרי קשר</a>",e)})):i("קישור לא תקין. לשאלות <a href=/contact>צרי קשר</a>")},ui.w.addEventListener("hashchange",e),e()});
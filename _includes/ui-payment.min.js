ui.payment=ui.legacy(function(){"use strict";var t,a,i,s,c=ui.d.getElementById("status"),u={toContact:" לשאלות אנא <a href=/contact>צרי קשר</a>"};return Object.assign(u,{notFound:"הזמנה זו לא נמצאה."+u.toContact,networkError:"ישנה תקלה בשרת."+u.toContact,networkOutage:"ישנה תקלה זמנית בשרת. אנא נסי שוב מאוחר יותר",serverError:"ישנה תקלה בשרת, אנא <a href=/contacts>צרי קשר</a> להמשך הטיפול בהזמנה",invalidRequest:"קישור לא תקין."+u.toContact}),(a=function(){var e,t,o,n=ui.d.pelepayform;s=ui.hash(),e=ui.serialize({orderid:s.orderid}),ui.pageProgress=ui.pageProgress||c.innerHTML,c.innerHTML=ui.pageProgress,history.replaceState&&(location.search&&(ui.log(location.href),history.replaceState("",ui.d.title,location.pathname+location.hash)),e&&e!==location.hash.substring(1)&&(location.search||ui.log(location.href),history.replaceState("",ui.d.title,location.pathname+"#"+e))),s.email&&(s.email=s.email.toLowerCase(),ui.setUser(ui.filterObj({email:s.email,tel:s.phone,firstname:s.firstname,lastname:s.lastname}))),s.orderid&&n?(o=function(){for(var e=location.hostname.split(".");2<e.length;)e.shift();return"https://lab.alaukstein.com/webhook"}(),t=["orderid","email","phone","firstname","lastname","utm_campaign","utm_source"],s=ui.filterObj(s,function(e){var r=t.includes(e)&&!/\*\|.*?\|\*/.test(s[e]);return r&&e.startsWith("utm_")&&ui.log(e,s[e]),r}),a.onlyFetch(function(e,r){s.token=r,fetch(o+"/payment",{method:"POST",redirect:"error",body:JSON.stringify(s)}).then(function(e){return a.verifyStatus(e,r,"notFound")}).then(function(e){return e.error?Promise.reject(e):e}).then(function(t){return t.custom?(ui.payment=t,Object.keys(t).forEach(function(e){var r=ui.d.createElement("input");r.type="hidden",r.name=e,r.value=t[e],n.appendChild(r)}),ui.log("Payment "+t.orderid+(t.email?" "+t.email:"")),console.log(t),void n.submit()):Promise.reject(new Error("serverError"))}).catch(function(e){r===i&&a.onError(u.notFound,e)})})):a.onError(u.invalidRequest)}).onlyFetch=function(e){var r;ui.w.AbortController&&(t&&t.abort(),r=(t=new AbortController).signal),"function"==typeof e&&e(r,i=ui.generateID())},a.onError=function(e,r){if("AbortError"!==(r=r||{}).name){switch(console.warn(s),r.message){case"notFound":case"serverError":console.error(r.message),e=u[r.message];break;case"Failed to fetch":console.error(r.message),e=u.networkOutage;break;case"NetworkError when attempting to fetch resource.":console.error(r.message),e=u.networkError}if(window.FS)try{FS.event("ConnectionError",ui.filterObj({payment_id_str:s&&s.orderid,payment_error_str:r.message}))}catch(e){console.error(e)}console.trace&&console.trace(),c.innerHTML="<div class=error>"+e+"</div>",t&&t.abort()}},a.verifyStatus=function(e,r,t){switch(e.status){case 200:return r===i&&e.json();case 400:return Promise.reject(new Error(t));case 503:return Promise.reject(new Error("serverError"));default:return Promise.reject(new Error("Failed to fetch"))}},ui.w.addEventListener("hashchange",a),a()});
ui.payment=ui.legacy(function(){"use strict";var o,i,s,c=ui.d.getElementById("status"),u={};return u.toContact=" לשאלות אנא <a href=/contact>צרי קשר</a>",Object.assign(u,{notFound:"הזמנה זו לא נמצאה."+u.toContact,networkError:"ישנה תקלה בשרת."+u.toContact,networkOutage:"ישנה תקלה זמנית בשרת. אנא נסי שוב מאוחר יותר",serverError:"ישנה תקלה בשרת, אנא <a href=/contacts>צרי קשר</a> להמשך הטיפול בהזמנה",invalidRequest:"קישור לא תקין."+u.toContact,hijacking:"ישנה תקלה, אנא <a href=/contacts>צרי קשר</a> להמשך הטיפול בהזמנה"}),(i=function(){var t,o,n=ui.d.pelepayform,a=ui.hash(),e=ui.serialize({orderid:a.orderid});ui.pageProgress=ui.pageProgress||c.innerHTML,c.innerHTML=ui.pageProgress,history.replaceState&&(location.search&&(console.log(location.href),history.replaceState("",ui.d.title,location.pathname+location.hash)),e&&e!==location.hash.substring(1)&&(location.search||console.log(location.href),history.replaceState("",ui.d.title,location.pathname+"#"+e))),a.email&&(a.email=a.email.toLowerCase(),ui.setUser(ui.filterObj({email:a.email,tel:a.phone,firstname:a.firstname,lastname:a.lastname}))),a.orderid&&n?(o=function(){for(var e=location.hostname.split(".");2<e.length;)e.shift();return"https://lab."+e.join(".")+"/webhook"}(),t=["orderid","email","phone","firstname","lastname","utm_campaign","utm_source"],a=ui.filterObj(a,function(e){var r=t.includes(e)&&!/\*\|.*?\|\*/.test(a[e]);return r&&e.startsWith("utm_")&&console.log(e,a[e]),r}),i.onlyFetch(function(e,r){a.token=r,fetch(o+"/payment",{method:"POST",redirect:"error",body:JSON.stringify(a)}).then(function(e){return i.verifyStatus(e,r,"notFound")}).then(function(e){return e.error?Promise.reject(e):e}).then(function(t){var e=t.custom&&ui.hash({hash:atob(t.custom),param:"token"});return e?e!==r?Promise.reject(new Error("hijacking")):(ui.payment=t,ui.cookie({paymentToken:e},259200),Object.keys(t).forEach(function(e){var r=ui.d.createElement("input");r.type="hidden",r.name=e,r.value=t[e],n.appendChild(r)}),console.log("Payment "+t.orderid+" "+t.email),console.log(t),void n.submit()):Promise.reject(new Error("serverError"))}).catch(function(e){r===s&&i.onError(u.notFound,e,a)})})):i.onError(u.invalidRequest,void 0,a)}).onlyFetch=function(e){var r;ui.w.AbortController&&(o&&o.abort(),r=(o=new AbortController).signal),"function"==typeof e&&e(r,s=Math.random().toString(16).substr(2,8).toUpperCase())},i.onError=function(e,r,t){if("AbortError"!==(r=r||{}).name){switch(console.warn(t),r.message){case"notFound":case"serverError":case"hijacking":console.error(r.message),e=u[r.message];break;case"Failed to fetch":console.error(r.message),e=u.networkOutage;break;case"NetworkError when attempting to fetch resource.":console.error(r.message),e=u.networkError}console.trace&&console.trace(),c.innerHTML="<div class=error>"+e+"</div>",o&&o.abort()}},i.verifyStatus=function(e,r,t){switch(e.status){case 200:return r===s&&e.json();case 400:return Promise.reject(new Error(t));case 503:return Promise.reject(new Error("serverError"));default:return Promise.reject(new Error("Failed to fetch"))}},ui.w.addEventListener("hashchange",i),i()});
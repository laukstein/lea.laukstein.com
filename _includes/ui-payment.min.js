ui.payment=ui.legacy(function(){"use strict";var e,r,t,o=ui.d.getElementById("status"),n={};return n.toContact=" לשאלות אנא <a href=/contact>צרי קשר</a>",Object.assign(n,{notFound:"הזמנה זו לא נמצאה."+n.toContact,networkError:"ישנה תקלה בשרת."+n.toContact,networkOutage:"ישנה תקלה זמנית בשרת. אנא נסי שוב מאוחר יותר",serverError:"ישנה תקלה בשרת, אנא <a href=/contacts>צרי קשר</a> להמשך הטיפול בהזמנה",invalidRequest:"קישור לא תקין."+n.toContact,hijacking:"ישנה תקלה, אנא <a href=/contacts>צרי קשר</a> להמשך הטיפול בהזמנה"}),r=function(){var e,a,i=ui.d.pelepayform,s=ui.hash(),c=ui.serialize({orderid:s.orderid});ui.pageProgress=ui.pageProgress||o.innerHTML,o.innerHTML=ui.pageProgress,history.replaceState&&(location.search&&history.replaceState("",ui.d.title,location.pathname+location.hash),c&&c!==location.hash.substring(1)&&history.replaceState("",ui.d.title,location.pathname+"#"+c)),s.email&&(s.email=s.email.toLowerCase(),ui.setUser(ui.filterObj({email:s.email,tel:s.phone,firstName:s.firstname,lastName:s.lastname},function(e,r){return!!r[e]}))),s.orderid&&i?(a=function(){for(var e=location.hostname.split(".");e.length>2;)e.shift();return"https://lab."+e.join(".")+"/webhook"}(),e=["orderid","email","phone","firstname","lastname","utm_campaign","utm_source"],s=ui.filterObj(s,function(r){var t=e.includes(r)&&!/\*\|.*?\|\*/.test(s[r]);return t&&r.startsWith("utm_")&&console.log(r,s[r]),t}),r.onlyFetch(function(e,o){s.token=o,fetch(a+"/payment",{method:"POST",redirect:"error",body:JSON.stringify(s)}).then(function(e){return r.verifyStatus(e,o,"notFound")}).then(function(e){return e.error?Promise.reject(e):e}).then(function(e){var r=e.custom&&ui.hash({hash:atob(e.custom),param:"token"});return r?r!==o?Promise.reject(new Error("hijacking")):(ui.payment=e,sessionStorage.paymentToken=r,Object.keys(e).forEach(function(r){var t=ui.d.createElement("input");t.type="hidden",t.name=r,t.value=e[r],i.appendChild(t)}),console.log("Payment "+e.orderid+" "+e.email),console.log(e),i.submit(),void 0):Promise.reject(new Error("serverError"))})["catch"](function(e){o===t&&r.onError(n.notFound,e,s)})})):r.onError(n.invalidRequest,void 0,s)},r.onlyFetch=function(r){var o;ui.w.AbortController&&(e&&e.abort(),e=new AbortController,o=e.signal),"function"==typeof r&&(t=Math.random().toString(16).substr(2,8).toUpperCase(),r(o,t))},r.onError=function(r,t,a){if(t=t||{},"AbortError"!==t.name){switch(console.warn(a),t.message){case"notFound":case"serverError":case"hijacking":console.error(t.message),r=n[t.message];break;case"Failed to fetch":console.error(t.message),r=n.networkOutage;break;case"NetworkError when attempting to fetch resource.":console.error(t.message),r=n.networkError}o.innerHTML="<div class=error>"+r+"</div>",e&&e.abort()}},r.verifyStatus=function(e,r,o){switch(e.status){case 200:return r===t&&e.json();case 400:return Promise.reject(new Error(o));case 503:return Promise.reject(new Error("serverError"));default:return Promise.reject(new Error("Failed to fetch"))}},ui.w.addEventListener("hashchange",r),r()});